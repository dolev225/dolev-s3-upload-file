import streamlit as st
import requests
import boto3
from io import BytesIO

st.set_page_config(page_title="S3 Uploader with Auth", page_icon="ğŸ”")

# --- ×ª×¤×¨×™×˜ ×¦×“ ×œ×”×’×“×¨×•×ª ×’×™×©×” ---
st.sidebar.header("ğŸ”‘ ×”×’×“×¨×•×ª ×’×™×©×” ×œ-AWS")
aws_access_key = st.sidebar.text_input("AWS Access Key:", type="password")
aws_secret_key = st.sidebar.text_input("AWS Secret Key:", type="password")
aws_region = st.sidebar.text_input("Region (×œ××©×œ us-east-1):", value="us-east-1")

st.sidebar.divider()
bucket_name = st.sidebar.text_input("×©× ×”-Bucket:")
s3_folder = st.sidebar.text_input("×ª×™×§×™×™×” ×‘-S3 (××•×¤×¦×™×•× ×œ×™):")

def get_s3_client():
    """×™×¦×™×¨×ª ×—×™×‘×•×¨ ×œ-S3 ×¢× ×”××¤×ª×—×•×ª ×©×”×•×–× ×•"""
    return boto3.client(
        's3',
        aws_access_key_id=aws_access_key,
        aws_secret_access_key=aws_secret_key,
        region_name=aws_region
    )

def upload_to_s3(file_obj, filename):
    if not aws_access_key or not aws_secret_key:
        st.error("×—×•×‘×” ×œ×”×–×™×Ÿ Access Key ×•-Secret Key ×‘×ª×¤×¨×™×˜ ×”×¦×“!")
        return

    try:
        s3_client = get_s3_client()
        full_path = f"{s3_folder}{filename}" if s3_folder else filename
        
        with st.spinner(f"××¢×œ×” ××ª {filename}..."):
            s3_client.upload_fileobj(file_obj, bucket_name, full_path)
        st.success(f"âœ… ×”×§×•×‘×¥ ×”×•×¢×œ×” ×‘×”×¦×œ×—×”!")
    except Exception as e:
        st.error(f"×©×’×™××” ×‘×”×¢×œ××”: {e}")

# --- ×××©×§ ×”××©×ª××© (Tabs) ---
st.title("â˜ï¸ ××¢×œ×” ×§×‘×¦×™× ×œ-S3")
tab1, tab2 = st.tabs(["ğŸ”— ×§×™×©×•×¨ (URL)", "ğŸ“ ×’×¨×™×¨×ª ×§×•×‘×¥"])

with tab1:
    url = st.text_input("×›×ª×•×‘×ª ×”-URL:")
    custom_name = st.text_input("×©× ×”×§×•×‘×¥ ×‘-S3 (×œ××©×œ image.jpg):")
    if st.button("×”×¢×œ×” ×-URL"):
        if url and custom_name:
            res = requests.get(url, stream=True)
            upload_to_s3(BytesIO(res.content), custom_name)

with tab2:
    uploaded_file = st.file_uploader("×’×¨×•×¨ ×§×•×‘×¥ ×œ×›××Ÿ")
    if st.button("×”×¢×œ×” ×§×•×‘×¥ ×©× ×’×¨×¨"):
        if uploaded_file:
            upload_to_s3(uploaded_file, uploaded_file.name)
